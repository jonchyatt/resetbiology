generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(auto()) @map("_id") @db.ObjectId
  memberID                String?                  // Unique tracking number (e.g., "RB-000001") - enforced in app logic
  name                    String?
  email                   String?                  @unique
  username                String?                  // User-chosen display username - enforced in app logic
  emailVerified           DateTime?
  image                   String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  auth0Sub                String?                  @unique
  rbClientId              String?                  @unique
  displayName             String?
  avatarUrl               String?
  role                    String                   @default("basic")
  profileJson             Json?
  permissionsJson         Json?
  accessLevel             String                   @default("guest") // "guest" | "introduction" | "subscriber" | "admin"
  permissions             Json?
  subscriptionStatus      String                   @default("none")

  // Introduction tier tracking (1-week free access after quiz + first login)
  introductionStartDate   DateTime?                // When introduction tier started (first login after quiz)
  introductionExpiresAt   DateTime?                // When introduction tier expires (7 days after start)
  quizSubmissionId        String?                  // Link to their NEPQ quiz submission
  subscriptionExpiry      DateTime?
  stripeCustomerId        String?
  trialStartDate          DateTime?
  trialEndDate            DateTime?
  drivePermissions        Json?
  driveFolder             String?
  googleDriveRefreshToken String?                  // Encrypted OAuth refresh token
  googleDriveConnectedAt  DateTime?                // When Drive was connected
  googleDriveSyncEnabled  Boolean                  @default(false)
  profileData             Json?
  irbApprovalStatus       String?
  irbSubmissionDate       DateTime?
  quizResponses           Json?
  onboardingComplete      Boolean                  @default(false)
  voiceMinutesRemaining   Int                      @default(60) // "Gas Tank" for voice agent
  voiceUsageLogs          VoiceUsageLog[]
  affiliateTracking       AffiliateTracking[]
  breathSessions          BreathSession[]
  progress                ClientProgress[]
  gamificationPoints      GamificationPoint[]
  moduleCompletions       ModuleCompletion[]
  peptide_orders          peptide_orders[]
  successDeposits         SuccessDeposit[]
  user_peptide_protocols  user_peptide_protocols[]
  dailyTasks              DailyTask[]
  foodEntries             FoodEntry[]
  mealPlans               MealPlan[]
  foodLogs                FoodLog[]
  workoutSessions         WorkoutSession[]
  workoutPrograms         WorkoutProgram[]
  workoutAssignments      WorkoutAssignment[]
  workoutCheckIns         WorkoutCheckIn[]
  journalEntries          JournalEntry[]
  notificationPreferences NotificationPreference[]
  scheduledNotifications  ScheduledNotification[]
  pushSubscriptions       PushSubscription[]
  pushSubscriptionHealth  PushSubscriptionHealth[]
  visionSessions          VisionSession[]
  visionProgress          VisionProgress[]
  nbackSessions           NBackSession[]
  nbackProgress           NBackProgress[]
  userBreathExercises     UserBreathExercise[]
  visionProgramEnrollment VisionProgramEnrollment?

  @@map("users")
}

model ClientProgress {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  metricType String
  value      Float
  date       DateTime @default(now())
  notes      String?
  user       User     @relation(fields: [userId], references: [id])

  @@map("client_progress")
}

model ModuleCompletion {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  moduleId       String
  completedAt    DateTime @default(now())
  localDate      String? // User's local date YYYY-MM-DD for timezone-safe bucketing
  localTime      String? // User's local time HH:MM:SS
  audioDuration  Int?
  fullCompletion Boolean  @default(false)
  user           User     @relation(fields: [userId], references: [id])

  @@map("module_completions")
}

model GamificationPoint {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  pointType      String
  amount         Int
  earnedAt       DateTime @default(now())
  activitySource String?
  user           User     @relation(fields: [userId], references: [id])

  @@map("gamification_points")
}

model SuccessDeposit {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String
  amount           Float
  status           String
  payoutConditions Json
  partnerShare     Float?
  createdAt        DateTime  @default(now())
  completedAt      DateTime?
  user             User      @relation(fields: [userId], references: [id])

  @@map("success_deposits")
}

model BreathSession {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String
  sessionType   String
  duration      Int
  cycles        Int?
  progressScore Float?
  createdAt     DateTime @default(now())
  localDate     String? // User's local date YYYY-MM-DD for timezone-safe bucketing
  localTime     String? // User's local time HH:MM:SS
  user          User     @relation(fields: [userId], references: [id])

  @@map("breath_sessions")
}

// Breath exercises that can be created by admins and chosen by users
model BreathExercise {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String   // e.g., "Vagal Reset", "Relaxation", "4-7-8 Breathing"
  slug            String   @unique // URL-friendly identifier
  description     String   // Description shown to users
  category        String   // "relaxation" | "energizing" | "vagal" | "sample"

  // Breathing pattern settings
  inhaleMs        Int      @default(4000)  // Inhale duration in ms
  exhaleMs        Int      @default(4000)  // Exhale duration in ms
  inhaleHoldMs    Int      @default(0)     // Hold after inhale
  exhaleHoldMs    Int      @default(0)     // Hold after exhale
  breathsPerCycle Int      @default(10)    // Breaths before hold phase
  cyclesTarget    Int      @default(3)     // Number of cycles

  // Optional hold phases between cycles
  postCycleExhaleHoldMs Int @default(0)   // Long exhale hold between cycles
  postCycleInhaleHoldMs Int @default(0)   // Recovery inhale hold

  // Audio/music settings
  backgroundMusic String?  // URL to music file or null for silence
  musicVolume     Float    @default(0.5) // 0-1 volume level
  guidedAudio     String?  // URL to voice guidance audio

  // Display settings
  isSample        Boolean  @default(false) // Can be shown on hero page
  isActive        Boolean  @default(true)  // Is available for users
  sortOrder       Int      @default(0)     // Display order

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Admin user ID who created it

  @@map("breath_exercises")
}

// User's active/saved breath exercises (similar to user_peptide_protocols)
model UserBreathExercise {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  exerciseId      String   @db.ObjectId // Reference to BreathExercise

  // User can customize settings from the base exercise
  customName      String?  // Optional user-given name
  inhaleMs        Int?     // Override base settings
  exhaleMs        Int?
  inhaleHoldMs    Int?
  exhaleHoldMs    Int?
  breathsPerCycle Int?
  cyclesTarget    Int?

  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, exerciseId])
  @@map("user_breath_exercises")
}

model AffiliateTracking {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  referralCode String   @unique
  clicks       Int      @default(0)
  conversions  Int      @default(0)
  commissions  Float    @default(0)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@map("affiliate_tracking")
}

model Assessment {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String?  @db.ObjectId
  responses    Json
  results      Json?
  irbSubmitted Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@map("assessments")
}

model VariableReward {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  rewardType String
  amount     Int
  claimedAt  DateTime @default(now())

  @@map("variable_rewards")
}

model Peptide {
  id                     String                   @id @default(auto()) @map("_id") @db.ObjectId
  slug                   String                   @unique
  name                   String
  dosage                 String?
  price                  Float
  originalUrl            String?
  casNumber              String?
  molecularFormula       String?
  purity                 String?
  halfLife               String?
  type                   String?
  classification         String?
  researchApplications   Json?
  keyBenefits            Json?
  keyFeatures            Json?
  mechanisms             Json?
  researchDosage         Json?
  researchProtocols      Json?
  color                  String?
  sequence               String?
  molecularWeight        String?
  storage                String?
  reconstitution         String?
  category               String
  subcategory            String?
  inStock                Boolean                  @default(true)
  featured               Boolean                  @default(false)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  peptide_education      peptide_education[]
  peptide_orders         peptide_orders[]
  user_peptide_protocols user_peptide_protocols[]

  @@map("peptides")
}

model peptide_categories {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String   @unique
  slug         String   @unique
  description  String?
  displayOrder Int?     @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
}

model peptide_doses {
  id                     String                 @id @default(auto()) @map("_id") @db.ObjectId
  protocolId             String                 @db.ObjectId
  protocolName           String? // Peptide name at time of logging (preserved even if protocol deleted)
  protocolSnapshot       Json? // Full protocol details at time of logging (dosage, frequency, timing)
  doseDate               DateTime
  dosage                 String
  time                   String?
  notes                  String?
  sideEffects            String?
  createdAt              DateTime               @default(now())
  localDate              String? // User's local date YYYY-MM-DD for timezone-safe bucketing
  localTime              String? // User's local time HH:MM:SS
  user_peptide_protocols user_peptide_protocols @relation(fields: [protocolId], references: [id])
}

model peptide_education {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  peptideId    String   @db.ObjectId
  title        String
  content      String
  type         String
  displayOrder Int?     @default(0)
  isPublished  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  peptides     Peptide  @relation(fields: [peptideId], references: [id])
}

model peptide_orders {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  peptideId    String   @db.ObjectId
  quantity     Int
  unitPrice    Float
  totalPrice   Float
  status       String   @default("pending")
  orderDate    DateTime @default(now())
  shippingInfo Json?
  trackingInfo Json?
  peptides     Peptide  @relation(fields: [peptideId], references: [id])
  users        User     @relation(fields: [userId], references: [id])
}

model user_peptide_protocols {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  userId                 String                  @db.ObjectId
  peptideId              String                  @db.ObjectId
  startDate              DateTime                @default(now())
  endDate                DateTime?
  dosage                 String
  frequency              String
  timing                 String? // Dose times (e.g., "08:00" or "08:00/20:00" for multiple times)
  notes                  String?
  isActive               Boolean                 @default(true)
  administrationType     String?                 @default("injection") // "injection" | "oral" | "nasal" | "topical"
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  peptide_doses          peptide_doses[]
  scheduledNotifications ScheduledNotification[]
  peptides               Peptide                 @relation(fields: [peptideId], references: [id])
  users                  User                    @relation(fields: [userId], references: [id])
}

model DailyTask {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  date      DateTime
  taskName  String // peptides, journal, workout, meals, module, breath
  completed Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date, taskName], name: "userId_date_taskName")
  @@map("daily_tasks")
}

model FoodEntry {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId   String   @db.ObjectId
  name     String
  calories Float
  protein  Float
  carbs    Float
  fats     Float
  mealType String // breakfast, lunch, dinner, snack
  loggedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id])

  @@map("food_entries")
}

model WorkoutSession {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  exercises   Json // Array of exercises with sets/reps/weight
  duration    Int // in seconds
  programId   String?
  notes       String?
  completedAt DateTime @default(now())
  localDate   String? // User's local date YYYY-MM-DD for timezone-safe bucketing
  localTime   String? // User's local time HH:MM:SS
  user        User     @relation(fields: [userId], references: [id])

  @@map("workout_sessions")
}

model JournalEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  entry     String // JSON string containing all journal data
  mood      String?
  weight    Float?
  date      DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("journal_entries")
}

model MealPlan {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  name          String
  planType      String // Muscle Building, Fat Loss, Keto, etc.
  dailyCalories Float
  proteinTarget Float
  carbsTarget   Float
  fatsTarget    Float
  description   String?
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])

  @@map("meal_plans")
}

model WorkoutProgram {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  name        String
  programType String // Push, Pull, Legs, Full Body, etc.
  template    Json // Array of exercises with sets/reps
  description String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@map("workout_programs")
}

model WorkoutProtocol {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  slug           String               @unique
  name           String
  summary        String?
  goal           String?
  level          String?
  durationWeeks  Int?
  sessionsPerWeek Int?
  tags           String[]
  focusAreas     String[]
  equipment      Json?
  readinessNotes Json?
  aiInsights     Json?
  researchLinks  Json?
  phases         Json
  isPublic       Boolean              @default(true)
  createdBy      String?
  updatedBy      String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  assignments    WorkoutAssignment[]

  @@map("workout_protocols")
}

model WorkoutAssignment {
  id                   String            @id @default(auto()) @map("_id") @db.ObjectId
  userId               String            @db.ObjectId
  protocolId           String            @db.ObjectId
  status               String            @default("active") // active, paused, completed, archived
  startDate            DateTime?
  endDate              DateTime?
  personalization      Json?
  readinessRules       Json?
  plan                 Json?
  currentSessionIndex  Int               @default(0)
  progress             Json?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  user                 User              @relation(fields: [userId], references: [id])
  protocol             WorkoutProtocol   @relation(fields: [protocolId], references: [id])
  checkIns             WorkoutCheckIn[]

  @@index([userId, status])
  @@map("workout_assignments")
}

model WorkoutCheckIn {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  userId        String             @db.ObjectId
  assignmentId  String?            @db.ObjectId
  readinessScore Float?
  energyLevel   Int?
  sorenessLevel Int?
  sleepHours    Float?
  stressLevel   Int?
  mood          String?
  painNotes     String?
  notes         String?
  tags          String[]
  metrics       Json?
  localDate     String?
  localTime     String?
  createdAt     DateTime           @default(now())
  user          User               @relation(fields: [userId], references: [id])
  assignment    WorkoutAssignment? @relation(fields: [assignmentId], references: [id])

  @@index([userId, createdAt])
  @@map("workout_checkins")
}

// --- STRIPE CATALOG MODELS (Mongo) ---
model Product {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  slug        String  @unique
  name        String
  description String?
  imageUrl    String?

  // Additional images and media
  allImages   Json? // Array of all product image URLs
  localImages Json? // Array of local image file paths
  videos      Json? // Array of video URLs (YouTube, etc)

  // Pricing
  partnerPrice Float? // Wholesale/partner price
  retailPrice  Float? // Customer price (with markup)

  // Protocol and dosage information
  protocolInfo       Json? // Object with dosage, frequency, timing, etc
  educationalContent Json? // Array of educational content
  learnMoreLinks     Json? // Array of learn more page URLs

  // Peptide Tracker Protocol Fields
  isTrackable                Boolean @default(false) // Show in peptide tracker
  protocolPurpose            String? // "Fat Loss", "Healing", "Performance", etc
  protocolDosageRange        String? // e.g., "0.5mg-2.5mg" or "250mcg"
  protocolFrequency          String? // e.g., "3x per week", "daily", "every other day"
  protocolTiming             String? // e.g., "AM", "PM", "twice daily"
  protocolDuration           String? // e.g., "8 weeks on, 8 weeks off"
  vialAmount                 String? // e.g., "10mg", "5mg"
  reconstitutionInstructions String? // e.g., "2ml BAC water"
  syringeUnits               Float? // For dosage calculator

  // Product variant fields
  baseProductName String? // Base name for grouping variants (e.g., "GHK-Cu")
  variantLabel    String? // Variant identifier (e.g., "50mg", "100mg", "5mg")
  variantOrder    Int?    @default(0) // Display order for variants (lower = first)

  // Inventory management
  trackInventory      Boolean @default(false) // Enable inventory tracking for this product
  quantityAvailable   Int?    @default(0) // Current stock level
  lowStockThreshold   Int?    @default(5) // Alert when stock falls below this number
  allowBackorder      Boolean @default(false) // Allow purchases when out of stock
  isBundle            Boolean @default(false) // Is this a bundle/package product
  bundlePriceOverride Int? // Manual price override for bundles (in cents)

  // Product flags
  active     Boolean @default(true)
  storefront Boolean @default(false)
  featured           Boolean @default(false)
  category           String? // Product category
  administrationType String? @default("injection") // "injection" | "oral" | "nasal" | "topical"

  // Stripe integration
  stripeProductId String?
  lastSyncedAt    DateTime?

  // Rich metadata
  metadata    Json?
  originalUrl String? // Original product URL from source

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prices                Price[]
  productPages          ProductPage[]
  bundleItems           BundleItem[]           @relation("BundleProduct")
  bundleComponents      BundleItem[]           @relation("ComponentProduct")
  waitlistEntries       WaitlistEntry[]
  inventoryTransactions InventoryTransaction[]
}

model Price {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  label      String?
  unitAmount Int
  currency   String  @default("usd")
  interval   String? // "month" | "year" | null for one-time
  isPrimary  Boolean @default(false)
  active     Boolean @default(true)

  stripePriceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id                    String  @id @default(auto()) @map("_id") @db.ObjectId
  stripeSessionId       String  @unique
  stripePaymentIntentId String?
  stripeCustomerId      String?
  productId             String? @db.ObjectId
  priceId               String? @db.ObjectId
  amountTotal           Int?
  currency              String?
  email                 String?
  status                String  @default("pending") // pending | paid | failed | refunded

  // Shipping Information
  shippingName       String?
  shippingLine1      String?
  shippingLine2      String?
  shippingCity       String?
  shippingState      String?
  shippingPostalCode String?
  shippingCountry    String?
  shippingPhone      String?

  // Fulfillment
  fulfillmentStatus String    @default("unfulfilled") // unfulfilled | processing | shipped | delivered
  trackingNumber    String?
  trackingUrl       String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Store full HTML content for product pages
model ProductPage {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  pageType    String // "main" | "learn_more" | "education"
  title       String?
  htmlContent String // Full HTML content
  textContent String? // Plain text version
  sourceUrl   String? // Original URL where content came from

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, pageType])
  @@map("product_pages")
}

model FoodRef {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  source        String
  sourceId      String
  description   String
  brand         String?
  servingGram   Float?
  per           String   @default("100g")
  nutrientsJson Json
  createdAt     DateTime @default(now())

  @@unique([source, sourceId], map: "foodref_source_sourceId")
  @@map("food_refs")
}

model FoodLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  loggedAt   DateTime @default(now())
  localDate  String? // User's local date as YYYY-MM-DD for timezone-safe bucketing
  localTime  String? // User's local time as HH:MM:SS
  source     String
  sourceId   String?
  itemName   String
  brand      String?
  quantity   Float    @default(1)
  unit       String   @default("serving")
  gramWeight Float?
  nutrients  Json
  photoUrl   String?
  notes      String?
  mealType   String   @default("snack")

  // AI Analysis Fields
  aiMetadata Json? // Full AI analysis (items breakdown, assumptions, ranges)
  confidence Float? // AI confidence score (0-1)
  aiSource   String? // "vision" | "voice" | "chat" | null

  @@index([userId, loggedAt], map: "foodlog_user_loggedAt")
  @@index([userId, localDate], map: "foodlog_user_localDate")
  @@map("food_logs")
}

// --- PWA NOTIFICATION MODELS ---
model NotificationPreference {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  protocolId      String   @db.ObjectId
  pushEnabled     Boolean  @default(true)
  emailEnabled    Boolean  @default(false)
  reminderMinutes Int      @default(15)
  timezone        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, protocolId])
  @@map("notification_preferences")
}

model ScheduledNotification {
  id           String                 @id @default(auto()) @map("_id") @db.ObjectId
  userId       String                 @db.ObjectId
  protocolId   String                 @db.ObjectId
  doseTime     DateTime
  reminderTime DateTime
  type         String // "push" | "email"
  sent         Boolean                @default(false)
  sentAt       DateTime?
  createdAt    DateTime               @default(now())
  user         User                   @relation(fields: [userId], references: [id])
  protocol     user_peptide_protocols @relation(fields: [protocolId], references: [id])

  @@index([reminderTime, sent])
  @@map("scheduled_notifications")
}

model PushSubscription {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  endpoint  String
  keys      Json // {p256dh, auth}
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, endpoint])
  @@map("push_subscriptions")
}

// --- NOTIFICATION MONITORING MODELS ---

// Tracks every cron job execution for health monitoring
model CronHealthCheck {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  cronType            String // "notification-send"
  status              String // "started" | "completed" | "failed"
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  duration            Int? // milliseconds
  notificationsFound  Int?
  notificationsSent   Int?
  notificationsFailed Int?
  errorMessage        String? // If failed
  errorStack          String? // Full stack trace
  metadata            Json? // Additional context

  @@index([cronType, startedAt])
  @@index([status, startedAt])
  @@map("cron_health_checks")
}

// Logs all email send failures for debugging
model EmailFailureLog {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  emailType    String // "dose-reminder" | "order-confirmation" | "seller-notification" | "shipping-confirmation"
  recipient    String // Email address
  userId       String?  @db.ObjectId // If applicable
  errorMessage String
  errorCode    String? // Resend error code
  errorStack   String? // Full stack trace
  payload      Json? // Email data that failed
  attemptedAt  DateTime @default(now())
  retryCount   Int      @default(0)
  retrySuccess Boolean  @default(false)

  @@index([emailType, attemptedAt])
  @@index([recipient, attemptedAt])
  @@map("email_failure_logs")
}

// Tracks push notification subscription health per user
model PushSubscriptionHealth {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  userId              String    @db.ObjectId
  subscriptionId      String    @db.ObjectId // Reference to PushSubscription
  lastSuccessSendAt   DateTime?
  lastFailureSendAt   DateTime?
  lastFailureReason   String?
  consecutiveFailures Int       @default(0)
  isHealthy           Boolean   @default(true)
  checkedAt           DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isHealthy])
  @@index([consecutiveFailures])
  @@map("push_subscription_health")
}

model VoiceUsageLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  minutes   Int
  agentType String   // "BIO_COACH", "VISION_TUTOR", etc.
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("voice_usage_logs")
}

// --- INVENTORY & BUNDLE MANAGEMENT ---

// Defines which products are in a bundle (e.g., "Glow Protocol" contains TB-500, BPC-157, GHK-Cu)
model BundleItem {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  bundleProductId    String  @db.ObjectId // The bundle product (e.g., "Glow Protocol")
  componentProductId String  @db.ObjectId // The component product (e.g., "TB-500")
  quantity           Int     @default(1) // How many of this component in the bundle
  isOptional         Boolean @default(false) // Optional add-on component
  displayOrder       Int     @default(0) // Order in which components are displayed

  bundleProduct    Product @relation("BundleProduct", fields: [bundleProductId], references: [id])
  componentProduct Product @relation("ComponentProduct", fields: [componentProductId], references: [id])

  createdAt DateTime @default(now())

  @@unique([bundleProductId, componentProductId])
  @@map("bundle_items")
}

// Tracks customer waitlist for out-of-stock products
model WaitlistEntry {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  productId  String    @db.ObjectId
  email      String
  name       String?
  notified   Boolean   @default(false)
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId, notified])
  @@map("waitlist_entries")
}

// Audit trail for all inventory changes
model InventoryTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  productId   String   @db.ObjectId
  type        String // "purchase", "restock", "adjustment", "bundle_sale"
  quantity    Int // Positive for additions, negative for reductions
  previousQty Int // Quantity before transaction
  newQty      Int // Quantity after transaction
  reason      String? // Optional explanation
  orderId     String? // Reference to order if applicable
  createdBy   String? // Admin user who made the change
  createdAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId, createdAt])
  @@map("inventory_transactions")
}

// --- ASSESSMENT FUNNEL ---
model AssessmentResponse {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Contact Information
  name     String
  email    String
  phone    String?
  location String? // IP-based location

  // Quiz Responses (Q5-Q19)
  // Best Practices (Q5-Q14): Support ranked multi-select (stored as JSON arrays)
  q5_protein_tracking   Json // String[] for ranked answers
  q6_stem_cell_support  Json
  q7_unified_tracking   Json
  q8_breathwork         Json
  q9_sleep_tracking     Json
  q10_detox_protocols   Json
  q11_journaling        Json
  q12_workout_program   Json
  q13_accountability    Json
  q14_peptide_knowledge Json

  // Qualifying Questions (Q15-Q19): Single-select only
  q15_current_situation String
  q16_desired_outcome   String
  q17_biggest_obstacle  String
  q18_ideal_solution    String
  q19_additional_info   String?

  // Calculated Fields
  score           Int // 0-100 based on Q5-Q14
  scoreCategory   String // "master", "strong", "gaps", "fresh"
  recommendedTier String // "diy", "guided", "done-with-you", "concierge"

  // Engagement Tracking
  timeToComplete      Int? // Seconds
  completedAt         DateTime  @default(now())
  viewedResults       Boolean   @default(false)
  clickedCTA          Boolean   @default(false)
  bookedCall          Boolean   @default(false)
  convertedToCustomer Boolean   @default(false)
  conversionDate      DateTime?

  // UTM & Source Tracking
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  referrer    String?

  // A/B Test Variant
  variant String? // "control" or "funnel-v1"

  @@index([email])
  @@index([score])
  @@index([completedAt])
  @@index([recommendedTier])
  @@map("assessment_responses")
}

// --- AI USAGE TRACKING ---

// Tracks all AI API usage for cost monitoring and rate limiting
model AIUsage {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  type       String // "image" | "chat" | "voice"
  model      String // "gpt-4o-mini", "whisper-1", etc.
  tokensUsed Int // Total tokens consumed
  cost       Float // Estimated cost in USD
  success    Boolean  @default(true)
  errorMsg   String? // If failed
  metadata   Json? // Additional context (image size, etc.)
  createdAt  DateTime @default(now())

  @@index([userId, type, createdAt])
  @@index([createdAt])
  @@map("ai_usage")
}

// --- VISION TRAINING SYSTEM ---

// Tracks individual vision training sessions
model VisionSession {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  visionType   String   // "near" | "far"
  exerciseType String   // "letters" | "e-directional"
  distanceCm   Float    // Distance achieved in cm
  accuracy     Float    // Percentage correct (0-100)
  chartSize    String   // Which line was being tested (e.g., "20/20", "20/40")
  duration     Int      // Session duration in seconds
  success      Boolean  // Did they pass this level?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("vision_sessions")
}

// Tracks overall vision training progress per user
model VisionProgress {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  visionType      String   // "near" | "far"
  currentLevel    Int      // Current difficulty level (1-10)
  maxDistanceCm   Float    // Best distance achieved
  lastSessionDate DateTime
  totalSessions   Int
  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, visionType])
  @@map("vision_progress")
}

// ============================================
// N-BACK MENTAL TRAINING MODELS
// ============================================

model NBackSession {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  gameMode        String   // "dual" | "triple"
  nLevel          Int      // N-back level (1, 2, 3, etc.)
  totalTrials     Int      // Number of trials in session
  positionHits    Int      // Correct position matches identified
  positionMisses  Int      // Missed position matches
  positionFalse   Int      // False positives for position
  audioHits       Int      // Correct audio matches identified
  audioMisses     Int      // Missed audio matches
  audioFalse      Int      // False positives for audio
  letterHits      Int?     // For triple mode: correct letter matches
  letterMisses    Int?     // For triple mode: missed letter matches
  letterFalse     Int?     // For triple mode: false positives for letter
  overallAccuracy Float    // Overall percentage (0-100)
  positionAccuracy Float   // Position-specific accuracy
  audioAccuracy   Float    // Audio-specific accuracy
  letterAccuracy  Float?   // Letter-specific accuracy (triple mode)
  durationSeconds Int      // Session duration
  levelAdvanced   Boolean  // Did user advance to next level?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("nback_sessions")
}

model NBackProgress {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  gameMode        String   // "dual" | "triple"
  currentNLevel   Int      @default(2) // Current N-back level
  highestNLevel   Int      @default(2) // Best N-level achieved
  bestAccuracy    Float    @default(0) // Best overall accuracy
  totalSessions   Int      @default(0)
  totalTrials     Int      @default(0)
  avgAccuracy     Float    @default(0)
  streakDays      Int      @default(0) // Consecutive days practiced
  lastSessionDate DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, gameMode])
  @@map("nback_progress")
}

// ============================================
// VISION MASTER PROGRAM ENROLLMENT
// ============================================
// Tracks user's progress through the 12-week ScreenFit program

model VisionProgramEnrollment {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @db.ObjectId @unique // One enrollment per user
  programId         String   @default("screenfit-12week") // Which program
  startDate         DateTime @default(now()) // When user started
  currentWeek       Int      @default(1)
  currentDay        Int      @default(1)
  status            String   @default("active") // "active" | "paused" | "completed" | "abandoned"

  // Baseline measurements (recorded at start)
  initialNearSnellen    String?  // e.g., "20/40"
  initialFarSnellen     String?  // e.g., "20/60"
  initialNearPointCm    Float?   // Near point of convergence

  // Current measurements (updated as they progress)
  currentNearSnellen    String?
  currentFarSnellen     String?
  currentNearPointCm    Float?
  currentReaderStage    Int      @default(0) // Reader glasses stage (0-5)

  // Progress tracking
  sessionsCompleted     Int      @default(0)
  totalPracticeMinutes  Int      @default(0)
  streakDays            Int      @default(0)
  longestStreak         Int      @default(0)
  lastSessionDate       DateTime?

  // Phase completion tracking
  phase1Complete        Boolean  @default(false) // Weeks 1-2
  phase2Complete        Boolean  @default(false) // Weeks 3-4
  phase3Complete        Boolean  @default(false) // Weeks 5-6
  phase4Complete        Boolean  @default(false) // Weeks 7-8
  phase5Complete        Boolean  @default(false) // Weeks 9-10
  phase6Complete        Boolean  @default(false) // Weeks 11-12

  pausedAt              DateTime?
  completedAt           DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id])
  dailySessions         VisionDailySession[]

  @@map("vision_program_enrollments")
}

// Tracks each daily session completion
model VisionDailySession {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  enrollmentId      String   @db.ObjectId
  userId            String   @db.ObjectId
  week              Int
  day               Int
  sessionTitle      String

  // Baseline test results for this session
  nearSnellenResult String?
  farSnellenResult  String?

  // Session metrics
  baselineMinutes   Int
  exerciseMinutes   Int
  totalMinutes      Int
  exercisesCompleted String[] // Array of exercise IDs completed

  // Performance data
  accuracy          Float?   // Overall accuracy if tracked
  notes             String?  // User notes
  coachFeedback     String?  // Any specific feedback

  completedAt       DateTime @default(now())
  localDate         String?  // User's local date YYYY-MM-DD

  enrollment        VisionProgramEnrollment @relation(fields: [enrollmentId], references: [id])

  @@index([enrollmentId, week, day])
  @@index([userId, localDate])
  @@map("vision_daily_sessions")
}

// ============================================
// VOICE AGENT TRAINING
// ============================================

model AgentTraining {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  agentId   String   // "CONCIERGE" | "BIO_COACH" | "VISION_TUTOR" | "PROFESSOR" | "SALES_CLOSER"
  userId    String   @db.ObjectId // Admin user who created the training
  content   String   // The training instructions
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, userId])
  @@map("agent_trainings")
}

// ============================================
// PRICING OFFERS
// ============================================
// Source of truth for pricing displayed in quiz and used by ONBOARDING agent

model Offer {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  slug            String   @unique  // "guided", "done-with-you", "concierge", "other"
  name            String   // "All Protocols + AI Coaching"
  tagline         String   // "Everything plus personalized guidance"
  trialPrice      String   // "$1" or "Book a call"
  monthlyPrice    String   // "$29/mo" or "$5,000+/mo"
  features        String[] // Array of feature strings
  highlighted     Boolean  @default(false) // Show as recommended/featured
  displayOrder    Int      @default(0)
  color           String   @default("teal") // "teal", "purple", "gold", "gray"
  ctaText         String   @default("Start Trial")
  ctaUrl          String?  // Override URL if needed (e.g., Calendly link)
  stripePriceId   String?  // Stripe Price ID for checkout
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("offers")
}

// ============================================
// NEPQ QUIZ FUNNEL SUBMISSIONS
// ============================================
// Stores responses from the NEPQ (Neuro-Emotional Persuasion Questioning) quiz funnel

model NEPQSubmission {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId

  // Section 1: Contact Intake
  name                  String
  email                 String
  phone                 String?

  // Section 2: Best Practices Audit (multi-select)
  bestPractices         Json      // Array of selected practice values with scores
  auditScore            Int       // Calculated score from audit
  auditLevel            String    // "beginner" | "intermediate" | "advanced" | "expert"

  // Section 3: Journey/Qualifying
  journeyStage          String    // "starting" | "stuck_6_12mo" | "plateaus_1_3yr" | "frustrated_3yr_plus"
  desiredOutcome        String    // "lose_fat" | "energy_vitality" | "break_plateau" | "sustainable_system"
  biggestObstacle       String    // "knowledge_gap" | "consistency" | "broken_metabolism" | "overwhelm"

  // Section 4: Black Swan - Success Vision
  successVision         String    // Textarea response - what success looks like
  successFeeling        String    // Textarea response - emotional meaning of success

  // Section 4: Challenges Assessment (NEW)
  eatingPatterns        Json?     // Array of selected eating pattern values
  obstacles             Json?     // Array of selected obstacle values
  categoryScores        Json?     // {mentalMastery, breathwork, tracking, workout, accountability, peptides}
  topRecommendations    Json?     // Array of top 3 recommendation objects

  // Section 5: Desire Amplification (MI Technique)
  whyChange             String    // Why are they thinking about change?
  readinessScore        Int       // 1-10 scale
  whyNotLower           String    // Why didn't they pick a lower number?
  positiveOutcomes      String?   // What positive outcomes would happen? (now optional - removed from quiz)
  whyImportant          String?   // Why are those outcomes important? (now optional - removed from quiz)

  // Section 6: Mental Mastery Preview (NEW)
  completedMentalMastery Boolean  @default(false)
  mentalMasteryDuration Int?      // How long they spent in seconds

  // Section 7: Energy Spin Up (moved)
  completedEnergySpin   Boolean   @default(false)
  energySpinDuration    Int?      // How long they spent in seconds

  // Section 7: Close
  viewedOffers          Boolean   @default(false)
  selectedOffer         String?   // "diy" | "guided" | "done-with-you" | "concierge" | "other"
  otherOfferRequest     String?   // If they selected "other", what did they want?

  // Conversion Tracking
  convertedAt           DateTime?
  stripeSessionId       String?   // If they started checkout
  conversionValue       Float?    // Amount if converted

  // Engagement Analytics
  startedAt             DateTime  @default(now())
  completedAt           DateTime?
  timeToComplete        Int?      // Total seconds from start to completion
  sectionsCompleted     Int       @default(0)
  lastActiveSection     String?   // Which section they were last on

  // UTM & Source Tracking
  utmSource             String?
  utmMedium             String?
  utmCampaign           String?
  referrer              String?
  userAgent             String?
  ipAddress             String?

  // A/B Testing
  variant               String    @default("nepq-v1")

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([email])
  @@index([selectedOffer])
  @@index([completedAt])
  @@index([auditLevel])
  @@map("nepq_submissions")
}
