<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zacurate Service Discovery</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <main>
    <header>
      <h1>üîç Zacurate Service Discovery</h1>
      <p class="lead">
        This tool will scan your Zacurate device and show ALL available Bluetooth services and characteristics.
      </p>
    </header>

    <section class="card">
      <h2>Step 1: Connect to Device</h2>
      <button id="discover-btn">Discover Device Services</button>
      <div id="status" class="status">Click button to start discovery...</div>
    </section>

    <section class="card">
      <h2>Discovery Results</h2>
      <pre id="results" class="log">Services will appear here...</pre>
    </section>

    <section class="card warnings">
      <h2>What This Does</h2>
      <p>This tool will:</p>
      <ul>
        <li>Connect to your selected Bluetooth device</li>
        <li>List ALL services it provides</li>
        <li>Show ALL characteristics for each service</li>
        <li>Display UUIDs we need to use in the main app</li>
      </ul>
    </section>
  </main>

  <script type="module">
    const discoverBtn = document.getElementById('discover-btn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    discoverBtn.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Opening Bluetooth picker...';
        resultsEl.textContent = '';

        // Request ANY Bluetooth device
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service', 'device_information'] // Common services
        });

        statusEl.textContent = `Connected to: ${device.name || 'Unknown Device'}`;
        log(`\nüì± Device Name: ${device.name || 'Unknown'}`);
        log(`üì± Device ID: ${device.id}`);
        log(`\nüîç Connecting to GATT Server...`);

        const server = await device.gatt.connect();
        log(`‚úÖ Connected!\n`);

        log(`üîé Discovering ALL services...\n`);
        const services = await server.getPrimaryServices();

        log(`Found ${services.length} service(s):\n`);
        log(`${'='.repeat(80)}\n`);

        for (let i = 0; i < services.length; i++) {
          const service = services[i];
          const serviceName = getServiceName(service.uuid);

          log(`\nüì¶ SERVICE ${i + 1}/${services.length}`);
          log(`   Name: ${serviceName}`);
          log(`   UUID: ${service.uuid}`);

          try {
            const characteristics = await service.getCharacteristics();
            log(`   Characteristics: ${characteristics.length} found\n`);

            for (let j = 0; j < characteristics.length; j++) {
              const char = characteristics[j];
              const charName = getCharacteristicName(char.uuid);
              const props = [];

              if (char.properties.read) props.push('READ');
              if (char.properties.write) props.push('WRITE');
              if (char.properties.writeWithoutResponse) props.push('WRITE_NO_RESPONSE');
              if (char.properties.notify) props.push('NOTIFY');
              if (char.properties.indicate) props.push('INDICATE');

              log(`     ${j + 1}. ${charName}`);
              log(`        UUID: ${char.uuid}`);
              log(`        Properties: ${props.join(', ')}`);

              // Try to read if possible
              if (char.properties.read) {
                try {
                  const value = await char.readValue();
                  const hex = Array.from(new Uint8Array(value.buffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                  log(`        Sample Value: ${hex}`);
                } catch (e) {
                  log(`        Sample Value: [Could not read]`);
                }
              }
              log('');
            }
          } catch (err) {
            log(`   ‚ùå Could not read characteristics: ${err.message}\n`);
          }
        }

        log(`\n${'='.repeat(80)}`);
        log(`\n‚úÖ DISCOVERY COMPLETE!`);
        log(`\n‚ÑπÔ∏è  Look for services with NOTIFY characteristics - those are likely the data streams.`);

        statusEl.textContent = 'Discovery complete! Check results below.';
        device.gatt.disconnect();

      } catch (err) {
        const msg = err.message || String(err);
        statusEl.textContent = `Error: ${msg}`;
        log(`\n‚ùå ERROR: ${msg}`);
      }
    });

    function log(message) {
      resultsEl.textContent += message + '\n';
    }

    function getServiceName(uuid) {
      const services = {
        '00001800-0000-1000-8000-00805f9b34fb': 'Generic Access',
        '00001801-0000-1000-8000-00805f9b34fb': 'Generic Attribute',
        '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information',
        '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
        '00001822-0000-1000-8000-00805f9b34fb': 'Pulse Oximeter',
      };
      return services[uuid] || 'Unknown Service';
    }

    function getCharacteristicName(uuid) {
      const characteristics = {
        '00002a00-0000-1000-8000-00805f9b34fb': 'Device Name',
        '00002a01-0000-1000-8000-00805f9b34fb': 'Appearance',
        '00002a19-0000-1000-8000-00805f9b34fb': 'Battery Level',
        '00002a29-0000-1000-8000-00805f9b34fb': 'Manufacturer Name',
        '00002a24-0000-1000-8000-00805f9b34fb': 'Model Number',
        '00002a5e-0000-1000-8000-00805f9b34fb': 'PLX Spot-Check Measurement',
        '00002a5f-0000-1000-8000-00805f9b34fb': 'PLX Continuous Measurement',
      };
      return characteristics[uuid] || 'Unknown Characteristic';
    }
  </script>
</body>
</html>
